# This Cloud Build pipeline is a reusable template for a single FAST stage.
# It is designed for multi-environment deployments using substitution variables.
# It runs a Terraform validate, plan, posts the plan to the PR, waits for manual approval,
# and then applies the plan.

# Default substitution variables. These are meant to be overridden in Cloud Build triggers.
substitutions:
  _TF_VARS_FILE: gcp-development.tfvars
  _GITHUB_TOKEN_SECRET_VERSION: projects/YOUR_GCP_PROJECT_ID_HERE/secrets/github-token/versions/latest

steps:
# 1. Initialize Terraform
- name: 'hashicorp/terraform:latest'
  id: 'Terraform init'
  entrypoint: 'sh'
  args: ['-c', 'terraform init']

# 2. Statically analyze the configuration for syntax errors.
- name: 'hashicorp/terraform:latest'
  id: 'Terraform validate'
  entrypoint: 'sh'
  args: ['-c', 'terraform validate']
  waitFor: ['Terraform init']

# 3. Generate the Terraform plan.
- name: 'hashicorp/terraform:latest'
  id: 'Terraform plan'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    terraform plan -var-file=${_TF_VARS_FILE} -out=tfplan
    terraform show -no-color tfplan > tfplan.txt
  waitFor: ['Terraform validate']

# 4. Make the PR comment script executable.
# The script is assumed to be in a 'scripts' directory at the repo root.
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Make script executable'
  entrypoint: 'sh'
  args: ['-c', 'chmod +x ../../../scripts/post-pr-comment.sh']

# 5. Post the plan to the GitHub PR for review.
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Post plan to PR'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
    export TF_PLAN=$(cat tfplan.txt)
    ../../../scripts/post-pr-comment.sh
  secretEnv: ['GITHUB_TOKEN']
  waitFor: ['Terraform plan']

# 6. Manual approval step.
- name: "gcr.io/cloud-builders/gcloud"
  id: "Manual approval"
  entrypoint: "bash"
  args: ["-c", "echo 'Waiting for manual approval before applying...'"]
  waitFor: ['Post plan to PR']
  timeout: 3600s

# 7. Apply the Terraform plan.
- name: 'hashicorp/terraform:latest'
  id: 'Terraform apply'
  entrypoint: 'sh'
  args: ['-c', 'terraform apply -auto-approve tfplan']
  waitFor: ['Manual approval']

availableSecrets:
  secretManager:
  - versionName: ${_GITHUB_TOKEN_SECRET_VERSION}
    env: 'GITHUB_TOKEN'
